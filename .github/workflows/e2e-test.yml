name: e2e tests

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        config: [Angular_Headless, React_Headless]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'  # Match your TargetFramework
      
      - name: Create .env
        run: |
          PSQL_USER=admin
          PSQL_PASSWORD=$(uuidgen | cut -d '-' -f1)
          PSQL_DB=itm

          cat > .env << EOF
          PSQL_USER=$PSQL_USER
          PSQL_PASSWORD=$PSQL_PASSWORD
          PSQL_DB=$PSQL_DB
          CONNECTIONSTRINGS__DBCONNECTIONSTRING=Host=db;Port=5432;Database=$PSQL_DB;Username=$PSQL_USER;Password=$PSQL_PASSWORD
          EOF
      
      - name: Start Docker services
        run: |
          docker compose up -d
          sleep 30
      
      - name: Wait for services
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:8080/api/system/info; do sleep 2; done'
          timeout 60 bash -c 'until curl -f http://localhost:8081; do sleep 2; done'
          timeout 60 bash -c 'until curl -f http://localhost:8082; do sleep 2; done'
      
      - name: Verify network connectivity
        run: |
          echo "=== Docker containers ==="
          docker compose ps
          echo "=== Backend API ==="
          curl -v http://localhost:8080/api/system/info
          echo "=== Angular UI ==="
          curl -I http://localhost:8081
          echo "=== React UI ==="
          curl -I http://localhost:8082
      
      - name: Restore dependencies
        working-directory: testautomation/SecretNick.TestAutomation/Tests
        run: dotnet restore Tests.csproj
      
      - name: Build tests
        working-directory: testautomation/SecretNick.TestAutomation/Tests
        run: dotnet build Tests.csproj -c ${{ matrix.config }} --no-restore
      
      - name: Install Playwright
        working-directory: testautomation/SecretNick.TestAutomation/Tests
        run: |
          # Adjust path based on your TargetFramework (netX.0)
          pwsh bin/${{ matrix.config }}/net9.0/playwright.ps1 install --with-deps chromium
      
      - name: Run tests
        working-directory: testautomation/SecretNick.TestAutomation/Tests
        run: |
          # Tests run on host and access Docker services via localhost
          dotnet test Tests.csproj -c ${{ matrix.config }} --no-build --logger trx
        env:
          # Override URLs if needed (defaults use localhost)
          TEST_BaseUrls__Api: "http://localhost:8080/"
          TEST_BaseUrls__Ui: "http://localhost:${{ matrix.config == 'Angular_Headless' && '8081' || '8082' }}"
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.config }}
          path: |
            testautomation/SecretNick.TestAutomation/Tests/bin/${{ matrix.config }}/net*/reqnroll_report.html
            testautomation/SecretNick.TestAutomation/Tests/bin/${{ matrix.config }}/net*/Screenshots/
            testautomation/SecretNick.TestAutomation/Tests/TestResults/*.trx
            testautomation/SecretNick.TestAutomation/Tests/logs/
          retention-days: 30
      
      - name: Cleanup
        if: always()
        run: docker compose down -v